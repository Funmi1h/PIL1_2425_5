{% extends 'base.html' %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
   
{% endblock %}
{% block content %}

<h2>Mise à jour du profil</h2>
<form action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <div id="map" style="width: 100%; height: 400px;"></div>
    <button type="submit">Mettre à jour</button>
</form>

<script>
    var map = L.map('map').setView([{{ form.instance.latitude|default:0 }}, {{ form.instance.longitude|default:0 }}], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var geocoder = L.Control.Geocoder.nominatim();
    var marker;

    map.on('click', function(e) {
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker(e.latlng, { draggable: true }).addTo(map);
        marker.on('dragend', function() {
            var latlng = marker.getLatLng();
            document.getElementById('id_latitude').value = latlng.lat;
            document.getElementById('id_longitude').value = latlng.lng;
        });
        document.getElementById('id_latitude').value = e.latlng.lat;
        document.getElementById('id_longitude').value = e.latlng.lng;
    });

    {% if (form.instance.adresse) %}
        geocoder.geocode('{{ form.instance.adresse }}', function(results) {
            if (results.length > 0) {
                var latlng = results[0].center;
                map.setView(latlng, 13);
                marker = L.marker(latlng, { draggable: true }).addTo(map);
                marker.on('dragend', function() {
                    var latlng = marker.getLatLng();
                    document.getElementById('id_latitude').value = latlng.lat;
                    document.getElementById('id_longitude').value = latlng.lng;
                });
            }
        });
    {% endif %}
</script>
{% endblock %}

